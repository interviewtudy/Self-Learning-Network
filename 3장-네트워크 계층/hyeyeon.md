# LAN을 넘어서는 네트워크 계층

LAN을 넘어서 다른 네트워크와 통신하기 위해서는 네트워크 계층의 역할이 필수적이다.
네트워크 계층에서는 IP주소를 이용해 송수신지 대상을 지정하고, 다른 네트워크에 이르는 경로를 결정하는 라우팅을 통해 다른 네트워크와 통신합니다.

## 데이터 링크 계층의 한계

물리 계층과 데이터링크 계층만으로 LAN을 넘어서 다른 네트워크와 통신하기 어렵다.

### 첫째, 물리 계층과 데이터 링크 계층만으로는 다른 네트워크까지의 도달 경로를 파악하기 어렵다

통신을 빠르게 주고 받을려면 최적의 경로로 패킷을 이동해야한다. 이때 패킷이 이동할 최적의 경로를 결정하는 것을 라우팅이라고 한다.
네트워크 계층이 있어야 네트워크 간의 라우팅이 가능하다.
라우팅을 수행하는 대표적인 장비로는 라우터가 있다.

### 둘쨰, MAC주소만으로는 모든 네트워크에 속한 호스트의 위치를 특정하기 어렵다

모든 호스트가 모든 네트워크에 속한 모든 호스트의 MAC주소를 서로 알고 있기란 어렵습니다. 그래서 MAC주소만으로는 이 세상에 있는 모든 호스트를 특정하기 어렵습니다.
네트워크를 통해 정보를 주고받는 과정은 택배를 송수신하는 과정과 같고, MAC주소는 NIC(네트워크 인터페이스)마다 할당된 고유한 정보이다.
택배에서 개인정보만으로 전송이 안되듯이 수신지를 정확히 알아야하는데 이러한 역할을 하는게 IP주소이다.

IP주소는 논리주소라고도 부른다. MAC 주소는 NIC마다 할당되는 고정된 주소이지만, IP주소는 호스트에 직접 할당이 가능하다. DHCP라는 프로토콜을 통해 자동으로 할당받거나 사용자가
할당할 수 있다.

정리하면, IP주소를 이용해 수신지 주소를 설정하거나, 해당 수신지까지의 최적의 경로를 결정하는 라우팅이 네트워크 계층에서 이루어지기 때문에 물리 계층과 데이터 링크 계층만으로는 네트워크 간의 통신이 어렵다.

## 인터넷 프로토콜 (IP)

### IP 주소 형태

IP주소는 4바이트를 주소를 표현할 수 있고, 숫자당 8비트로 표현되기에 0~255범위 안에 있는 네 개의 10진수로 표기한다.

### 기능

1. IP 주소 지정
   IP주소를 바탕으로 송수신 대상을 지정하는 것을 의미
2. IP 단편화
   IP단편화는 전송하고자 하는 패킷의 크기가 MTU라는 최대 전송 단위보다 클 경우, 이를 MTU 크기 이하의 복수 패킷을 나누는 것을 의미
   MTU란 한 번에 전송 가능한 IP 패킷의 최대 크기를 의미한다. IP 패킷의 해더고 MTU 크기에 포함된다. 패킷은 수신지에 도착하면 다시 재조합한다.
   </br>
   IP로 주고받는 패킷에는 어떤 정보가 포함되어 있어서 가능한걸까

#### IPv4 패킷

프레임의 데이터 필드에는 상위 계층에서 전달받거나 상위 계층으로 전달해야 할 내용이 명시되어 있다.
IPv4 패킷은 프레임의 페이로드로 데이터 필드에 명시되어 있다.

##### 핵심이 되는 필드 7개

1. 식별자
   패킷에 할당된 번호. 여러 조각으로 쪼개진 패킷들을 수신지에서 재조합할 수 있도록 어떤 메시지에서 부터 쪼개 졌는지 인식하기 위한 식별자를 사용
2. 프래그

   - 세 개의 비트로 구성된 필드, 1번째 비트는 항상 0으로 예약됨
   - 나머지 두 개의 비트 중에서 하는 DF(Don't Fragment)라는 이름이 붙은 비트로 IP 단편화를 수행하지 말라는 표시
     - 만약 이 비트가 1로 설정되어 있다면 IP 단편화를 수행하지 않고, 0으로 설정되어 있다면 IP단편화가 가능하다.
   - 나머지는 MF라는 비트로 단편화된 패킷이 더 있는지 나타낸다. 0이라면 마지막, 1이라면 쪼개진 비트가 더 있다는 것을 의미

3. 단편화 오프셋
   패킷이 단편화되기 전에 패킷이 초기 데이터에서 몇 번째로 떨어진 패킷인지 나타낸다. 단편화 되어 전송되는 패킷들은 수신자에 순서대로 도착하지 않을 수 있다. 따라서 수진자가 패킷들을 순서대로 재조립하려면 단편화된 패킷이 초기 데이터에서 몇 번째 데이터에 해당하는 패킷인지 알아야한다. 이를 판단하기 위해 간편화 오프셋이 활용된다.
4. TTL(Time To Live)
   - 패킷의 수명을 의미한다. 멀리 떨어진 호스트끼리 통신할 때 패킷은 여러 라우터를 거펴 이동할 수 있다. 패킷이 하나의 라우터를 거칠 때마다 TTL이 1씩 감소하며, TTL 값이 0으로 떨어진 패킷은 폐기된다.
   - 패킷이 호스트 또는 라우터에 한 번 전달되는 것을 홉이라고 한다. 즉, TTL 필드의 값은 홉마다 1씩 감소한다, TTL 필드의 존재 이유는 무의미한 패킷이 네트워크 상에 지속적으로 남아 있는 것을 방지하기 위함
   - TTL 필드가 0이 되면 해당 패킷은 폐기되고, 패킷을 송신한 호스트에게 시간 초과 메시지가 전송된다. 이를 일려주는 프로토콜이 ICMP입니다.
5. 프로토콜
   IP 패킷의 프로토콜은 상위 계층의 프로토콜이 무엇인지 나타내는 필드이다. (TCP = 6번, UDP = 17번)
6. 송신지 IP주소

7. 수신지 IP주소

IPv4는 식별자, 플래그, 단편화 오프셋으로 단편화와 재조합을 할 수 있고, 프로토콜 필드로 상위 계층 프로토콜을 알 수 있으며, TTL로 패킷의 남은 수명을 파악할 수 있다. 또한, 송신지 IP 주소, 수신지 IP주소를 통해 IP주소를 지정할 수 있다.

#### IPv6

IPv4의 주소의 총량은 쉽게 고갈 될 수 있다, 이런 이유에서 등장하는 것이 IPv6이다.
IPv6는 16바이트로 주소를 표현할 수 있고. 콜론(:)으로 구분된 8개 그룹의 16진수로 표기된다.

IPv6의 헤더는 4에 비해 간소화 되어 있다.

1. 다음 헤더
   상위 계층의 프로토콜을 가리키거니 확장 헤더를 가리킨다. 여기서 확장 헤더란 기본 헤더와 더불어 확장 헤더라는 추가 헤더를 가질 수 있다. - 송신지에서 수신지에 이르는 모든 경로의 네트워크 장비가 패킷을 검사하도록 하는 홉 간 옵션 - 수신지에서만 패킷을 검사하도록 하는 수신지 옵션 - 라우팅 관련 정보를 운반하는 라우팅 - 단평화를 위한 단편화 - 암호화를 위한 ESP, AH 확장헤더가 있다
2. 홉 제한
   IPv4 패킷의 TTL 필드와 비슷하게 패킷의 수명을 나타내는 필드이다.

3. 송신지 IP 주소
4. 수신지 IP 주소

## ARP

통신시 IP주소를 우선시 하여 통신하기에 MAC주소는 잘 알지 못하는 상황이 있을 수 있다. 이럴 때 ARP라는 프로토콜을 사용합니다.
ARP는 IP주소를 통해 MAC 주소를 알아내는 프로토콜이다. 동일 네트워크 내에 있는 송수신 대상의 IP주소를 통해 MAC주소를 알아낼 수 있다.

### 동작 과정

1. ARP 요청
   A는 네트워크 내의 모든 호스트에게 브로드 캐스트 메시지를 보냅니다. 메시지는 ARP 요청이라는 ARP 패킷입니다, (나 10.0.0.2랑 소통하고 싶은데 주소 알고 계신분~~~?)
2. ARP 응답
   대상이 아닌 호스트는 이를 무시하지만, 대상인 호스트는 MAC주소를 담은 메시지를 전송함. 이 유니캐스트 메시지는 ARP 응답이라는 ARP 패킷입니다.
3. ARP 테이블 갱신
   ARP를 활용할 수 있는 호스트는 테이블 정보를 유지한다. ARP테이블은 IP주소와 그에 맞는 MAC 주소 테이블을 대응하는 표입니다. A는 1,2 단계를 통해 B의 MAC 주소를 알게 되면 IP주소와 MAC 주소의 연관 관계를 ARP 테이블에 추가합니다. ARP 테이블은 일정 시간이 지나면 삭제되고, 임의로 삭제할 수도 있습니다.

# IP 주소

하나의 IP주소는 네트워크 주소, 호스트 주소로 이루어져있음. 네트워크를 표현하는 부분과, 호스트를 표현하는 부분으로 이루어져있다.
전자는 호스트가 속한 특정 네트워크를 식별하는 역할을 하며, 후자는 네트워크 내에서 특정 호스트를 식별하는 역할을 한다.

## 네트워크 주소와 호스트 주소

## 공인 IP 주소와 사설 IP 주소

### 공인 IP 주소

전 세계에서 고유한 IP주소. 네트워크 간의 통신 이를태면 인터넷을 이용할 때 사용하는 IP주소가 바로 공인 IP주소이다.
공인 IP 주소는 ISP나 공인 IP 주소 할당 기관을 통해 할당 받을 수 있다.

### 사설 IP 주소

(외부 네트워크에 공개되지않은)사설 네트워크에서 사용하기 위한 IP주소, 사용되는 네트워크 기기의 IP주소를 전부 별도로 신청해서 할당 받지않는다.
사설 IP주소의 할당 주체는 일반적으로 라우터이다. 할당 받은 사설 IP주소는 해당 호스트가 속한 사설 네트워크 상에서만 유효한 주소이다. 얼마든지 다른 네트워크 상의 사설 IP주소와 중복될 수 있다.

그래서 사설 IP주소만으로는 일반적인 인터넷 접속을 비롯한 외부 네트워크 간의 통신이 어렵다

그래서 외부 네트워크와 통신하기 위해서 NAT기술을 사용해야한다. NAT은 IP주소를 변환하는 기술이다. 주로 네트워크 내부에서 사용되는 사설 IP주소와 네트워크 외부에서 사용되는 공인 IP주소를 변환하는데 사용된다. NAT를 통해 사설 IP주소를 사용하는 여러 호스트는 적은 수의 공인 IP주소를 공유할 수 있다.

대부분의 라우터와 공유기는 NAT 기능으르 내장하고 있다. 그렇기에 사설 네트워크에서 만들어진 패킷 속 사설 IP주소는 공유기를 거쳐 공인 IP로 변경되고, 외부 네트워크로 전송된다.
반대로 외부 네트워크로부터 받은 패킷 속 공인 IP 주소는 공유기를 거쳐 사설 IP주소로 변경되어 사설 네트워크 속 호스트에 이르게 된다.

## 정적 IP 주소와 동적 IP주소

### 정적 할당

호스트에 직접 수작업으로 IP 주소를 부여하는 방법
일반적으로 부여하고자 하는 IP주소, 서브넷 마스트, 게이트웨이 주소, DNS 주소를 입력하면 호스트는 입력한 IP주소에 해당하는 고정된 주소를 가지게 된다.

### 동적 할당과 DHCP

IP 주소를 정적으로만 할당하다 보면 호스트의 수가 많아질 경우 관리가 곤란해질 수 있다. 의도치 않게 잘못된 IP주소를 입력 할 수도 있고, 중복된 IP주소를 입력할 수도 있다.

이럴 때 사용 가능한 IP 주소 할당 방식이 동적할당이다. 동적 할당은 정적 할당과는 달리 IP주소를 직접 일일이 입력하지 않아도 호스트에 IP주소가 동적으로 할당되는 방식이다.
이렇게 할당된 IP주소를 동적 IP주소라고 한다.

동적 IP주소는 사용되지 않을 경우 회수되고, 할당 받을 때마다 다른 주소를받을 수 있다.

IP동적 할당에 사용되는 대표적인 프로토콜이 바로 DHCP이다.

DHCP를 통한 IP주소 할당은 IP주소를 할당박고자 하는 호스트 와 해당 호스트에게 IP주소를 제공하는 DHCP 서버 간에 메시지를 주고받음으로써 이루어진다.
DHCP 서버의 역할은 일반적으로 라우터가 수행하지만, 특정 호스트에 DHCP 서버 기능을 추가할 수 있다. DHCP 서버는 클라언트에게 할당 가능한 IP주소 목록으르 관리하다가 클라이언트가 요청할 때 IP주소를 할당한다.

IP주소를 할당받는 과정에서 클라이언트와 DHCP 서버간에 주고받는 메시지의 종류는 크게 네 가지가 있다.

1. DHCP Discover(발견하다) (클라이언트 -> 서버)
   쿨라이언트는 DHCP Discover 메시지를 통해 DHCP 서버를 찾습니다. 이는 브로드캐스트로 전송됩니다. 클라이언트는 아직 할당 받지 못했기에 송신지 IP주소는 0.0.0.0으로 설정됩니다.
2. DHCP Offer (서버 -> 클라이언트)
   서버는 메시지를 받고 클라이언트에게 offer메시지(IP주소, 서브넷 마스크, 임대 기간)를 보냄
3. DHCP Request (클라이언트 -> 서버)
   오퍼에 대한 응답, 이것도 브로드 캐스트 (나 이거 진짜 써도 돼?)
4. DHCP Acknowledgment (DHCP ACK) (서버 -> 클라이언트)
   최종 승인과 같은 ACK를 전송함, 이를 받은 클라이언트는 할당받은 IP주소를 자신의 IP주소로 설정한 뒤 임대 기간 동안 IP를 사용한다.

IP주소의 사용 기간이 모든 끝나 IP주소가 DHCP 서버에 반납되면 이 과정을 다시 거침.
근데 기간 만료전에 연장할 수 있는데 이를 임대 갱신이라고 한다.
임대 갱신은 IP주소의 임대기간이 끝나기 전에 기본적으로 두 차례 자동으로 수행된다.

# 라우팅

패킷이 이동할 최적의 경로를 설정한 뒤 해당 경로로 패킷을 이동시키는 것. 이를 라우팅이라고 한다.

- 정적 라우팅
- 동적 라우팅
  - IGP
  - EGP

## 라우터(L3스위치)

멀리 떨어져 있는 호스트간의 통신 과정애서 패킷은 서로에게 도달하기까지 여러 라우터를 거쳐서 다양한 경로로 아동할 수 있다.
라우팅 도중 패킷이 호스트ㅘ 라우터 간에, 혹은 라우터와 라우터 간에 이동하는 하나의 과정을 홉이라고 부른다.

패킷은 여러 홉을 거쳐 라우팅 될 수 있는 것이다.
다음 홉이 어디인지 알려면 라우팅 테이블을 사용한다.

## 라우팅 테이블

라우터가 저장하고 관리하는 라우팅 테이블이다. 라우팅 테이블은 특정 수신지까지 도달하기 위한 정보를 명시한 일종의 표와 같은 정보이다.
라우터는 라우팅 테이블을 참고하여 수신지까지의 도달 경로를 판단한다.

### 테이블에 저장되는 정보

1. 수신지 IP주소와 서브넷 마스크: 최종적으로 패킷을 전달할 대상
2. 다음 홉: 최종 수신지까지 가기 위해 다음으로 거쳐야 할 로스트의 IP주소나 인터페이스르 의미한다. 게이트웨이라고 명시되기도 한다,
3. 네트워크 인터페이스: 패킷을 내보낼 통로, 인터페이시 이름이 명시되거나 대응되는 IP주소가 명시되기도 함
4. 메트릭: 해당 경로로 이동하는 데에 드는 비용

라우팅 테이블에 없는 경로로 패킷을 전송해야할 때가 있음. 이 경우 기본적으로 패킷을 내보낼 경로를 설정하여 해당 경로로 패킷을 내보낼 수 있다. 이 기본 경로를 디폴트 라우트라고 한다.

기본 게이트웨이는 호스트가 속한 네트워크 외부로 나아가기 위한 첫 번째 경로이고, 일반적으로 라우터 주소를 의미하는 경우가 많다.
기본 게이트로 나아가기 위한 경로가 디폴트 라우트인 셈

라우팅을 해주는 네트워크 장비인 라우터는 라우팅 테이블을 통해 패킷을 수신지까지 전달 할 수 있다.
라우팅 테이블 안에는 네트워크 상의 특정 수신지까지 도달하기 위한 정보들이 담겨 있다.

## 정적 라우팅과 동적 라우팅

### 정적 라우팅

사용자가 수동으로 직접 채워 넣은 라우팅 테이블의 항목을 토대로 라우팅되는 방식

### 동적 라우팅

자동으로 라우팅 테이블 항목을 만들고, 이를 이용하여 라우팅하는 방식을 의미. 이러한 이유로 동적 라우팅을 하면 라우팅 테이블 항목이 수시로 변할 수 있다.

라우팅 테이블의 항목을 수동으로 입력할 필요가 없다면 대규모 네트워크를 관리하는데 있어서 편리해지낟. 그뿐만 아니라 네트워크 경로상에 문제가 발생했을 때 이를 우회할 수 있게 경로가
자동으로 갱신되기도 한다,

동적 라우팅은 어떻게 자동으로 라우팅 테이블 항목을 만드는것일까? 모든 라우터는 특정 수신지까지 도달하기 위한 최적의 경로를 찾아 라우팅 테이블에 추가하려 노력한다.
이를 위해 라우터끼리 서로 저옵를 통신하게 되는데, 이 과정에서 사용되는 프로토콜이 바로 라우팅 프로토콜이다.

## 라우팅 프로토콜

라우터끼리 자신들의 정보를 교환하며 패킷이 이동할 최적의 경로를 찾기 위한 프로토콜이다.
라우팅 프로토콜은 크게 AS 내부에서 수행되거나, AS 외부에서 수행되거나에 따라 종류를 나눌 수 있습니다. 전자를 IGP, 후자를 ESP라고 한다. 대표적인 IGP로는 RIP과 OSPF가 있다.
ESP로 BGP가 있다.

### IGP: RIP와 OSPF

대표적인 IGP로는 RIP와 OSPF가 있습니다. 이 프로토콜들은 최적의 경로를 선정하는 과정에서 거리 벡터가 사용되느냐, 링크 상태가 사용되는냐로 구분할 수 있다.
RIP는 거리 벡터를, OSPF는 링크 상태를 사용하는 라우팅 프로토콜입니다.

#### RIP

거리 벡터 기반의 라우팅 프로토콜. 여기서 거리 벡터 라우팅 프로토콜이란 거리를 기반으로 최적의 경로를 찾는 라우팅 프로토콜을 의미. 그리고 거리는 패킷이 정유하는 라우터의 수, 즉 홉의 수를 의미합니다.

#### OSPF

링크 상태 라우팅 프로토콜이다.
