# LAN을 넘어서는 네트워크 계층

## 데이터 링크 계층의 한계

1. 물리 계층과 데이터 링크 계층만으로는 다른 네트워크까지의 도달 경로를 파악하기 어려움

- 물리 계층과 데이터 링크 계층은 기본적으로 LAN 을 다루지만 실제론 수많은 네트워크 장비를 사용
- 물릭 계층과 데이터 링크 계층의 장비로는 라우팅 수행이 불가능함
- 라우팅: 패킷이 이동할 최적의 경로를 결정하는 것. 라우터를 통해 라우팅을 수행함

2. MAC 주소만으로는 모든 네트워크에 속한 호스트의 위치를 알기 어려움

- MAC 주소와 IP 주소를 함께 사용하되, IP 주소를 우선으로 활용
- IP 주소는 논리 주소라고 불리며 호스트에 직접 할당할 수 있음
- DHCP(Dynamic Host Configuration Protocol) 을 통해 IP 를 자동으로 할당 받거나 사용자가 직접 할당할 수 있음
- 한 호스트가 복수의 IP 주소를 가질 수 있음

<br/><br/>

## 인터넷 프로토콜

- 인터넷 프로토콜에는 IPv4, IPv6 가 있고, IP 주소를 이야기할 땐 주로 IPv4를 의미함
- IP 주소는 4바이트로 표현. 8비트로 표현한 4개의 10진수로 표현되는데 그 수를 옥텟이라고 함
- IP 주소 지정과 IP 단편화라는 기능이 있음
  - IP 주소 지정: IP 주소를 바탕으로 송수신 대상을 지정하는 것
  - IP 단편화: 전송하고자 하는 패킷의크기가 MTU 보다 클 경우, MTU 크기 이하의 복수의 패킷으로 나누는 것
  - MTU(Maximum Transmission Unit): 한 번에 전송 가능한 IP 패킷의 최대 크기

### IPv4

- 프레임의 페이로드로, 데이터 필드에 명시됨
- 식별자, 플래그, 단편화 오프셋, TTL, 프로토콜, 송신지 IP 주소, 수신지 IP 주소 등으로 구성
  - 식별자: 패킷에 할당된 번호. 패킷이 쪼재져서 전송됐다면 수신지에서 재조합하기 위해 어떤 메시지로부터 쪼개졌는지 알려줌
  - 플래그: 세 개의 비트로 구성된 필드
    - 첫 번째 비트: 항상 0으로 예약된 필드. 현재 사용하지 않음
    - 두 번째 비트: DF(Don't Fragment)라는 이름의 비트로 IP 단편화를 사용하지 말라는 표시
    - 세 번째 비트: MF(More Framgent)라는 이름의 비트로 단편화 패킷이 더 있는지를 나타냄
- 단편화 오프셋: 패킷이 단편화되기 전 패킷의 초기 데이터에서 몇 번쨰로 떨어진 패킷인지 나타냄
- TTL(Time To Live): 홉마다 1씩 감소되어 0으로 된 패킷은 폐기됨.
  - 홉: 패킷이 호스트 또는 라우터에 한 번 전달되는 것
  - 무의미한 패킷이 네트워크 상에 지속적으로 남아있는 것을 방지
  - TTL 필드가 0이되면 패킷을 송신한 호스트에게 시간 초과 메시지가 전달됨
- 프로토콜: 상위 계층의 프로토콜이 무엇인지 나타내는 필드. TCP 는 6번, UDP 는 17번
- 송신지 IP 주소 & 수신지 IP 주소: 송수신지의 IPv4 주소

### IPv6

- IPv4의 총량이 쉽게 고갈될 수 있어 등장함
- 16바이트로 표현. 콜론(:)으로 구분된 8개 그룹의 16진수로 표
- 다음 헤더, 홉 제한, 송신지 IP 주소, 수신지 IP 주소 등으로 구성
  - 다음 헤더: 상위 계층의 프로토콜 또는 확장 헤더를 가리킴.
    - 확장 헤더: IPv6는 IPv4에 비해 간소화 된 기본 헤더를 가지는데 추가 정보가 필요할 경우 확장 헤더라는 추가 헤더를 사용함. 기본 헤더와 페이로드 데이터 사이에 위치함. 홉 간 옵션, 수신지 옵션 등 다양한 정보 운반 가능
  - 홉 제한: IPv4의 TTL 필드와 비슷하게 패킷의 수명을 나타냄
  - 송신지 IP 주소 & 수신지 IP 주소: 송수신지의 IPv6 주소
- 기본 헤더에 단편화 관련 필드가 없고 단편화 확장 헤더를 통해 단편화가 이루어짐. 단편화 오프셋, M 프래그, 식별자 필드를 통해 IPv4의 단편화 오프셋, MF 플래그, 식별자 필드 역할을 수행함.
  - 단편화 오프셋: 전체 메시지에서 현재 단편화된 패킷의 위치

<br/><br/>

## ARP(Address Resolution Protocol)

IP 주소를 통해 MAC 주소를 알아내는 프로토콜

- 동일 내트워크 내 동작 과정: ARP 요청 -> APR 응답 -> APR 테이블 갱신
  - ARP 요청: 네트워크 내 모든 호스트들에게 브로드캐스트 메시지로 ARP 요청을 보냄
  - ARP 응답: APR 요청을 수신하면 요청에 해당하는 IP 주소의 호스트가 APR 응답을 전송하여 MAC 주소를 알게 됨
  - ARP 테이블 갱신: IP 주소와 그에 맞는 MAC 주소를 대응하는 표로 1,2 단계에서 IP 주소의 MAC 주소의 연관 관계를 알게되면 테이블에 추가함. 일정 시간이 지나면 삭제되고 임의로 삭제하는 것도 가능함. 테이블에 맵핑이 되어있다면 ARP 요청 없이도 MAC 주소를 알 수 있음
- 다른 네트워크에 있다면 네트워크 외부로 나가기 위한 장비(라우터)의 MAC 주소를 알아내어 패킷을 전송함

### IP 단편화를 피하는 방법

- 데이터가 여러 패킷으로 쪼개지면 전송해야할 패킷의 헤더가 늘어나고 이는 불필요한 트래픽 증가와 대역폭 낭비로 이어질 수 있음
- 경로 MTU: 경로 내에서 사용하는 네트워크 장비들의 MTU 값의 최솟값
- 경로 MTU 발견: 경로 MTU 를 구해 해당 크기만큼 송수신하여 IP 단편화를 회피하는 기술. DF 플래그를 설정하여 IP 패킷을 전달한 호스트가 단편화를 진행할 수 없다는 오류 메시지를 전달하면 이런 오류를 전달받지 않을 때까지 데이터 크기를 점차 줄여 서로의 경로 MTU 를 알게

<br/><br/><br/><br/>

# IP 주소

## 네트워크 주소와 호스트 주소

- 네트워크 주소: 네트워크 ID, 네트워크 식별자 등으로 부르기도 함
- 호스트 주소: 호스트 ID, 호스트 식별자 등으로 부르기도 함
- IP 주소에서 네트워크 주소와 호스트 주소를 구분하는 범위는 유동적일 수 있음
- 호스트 주소 공간을 크게 할당하면 다수의 IP 주소가 낭비될 수 있고, 호스트 주소 공간을 작게 할당하면 호스트가 사용할 IP 주소가 부족해질 수 있으므로 **클래스** 를 통해 이 문제를 해결

<br/><br/>

## 클래스풀 주소 체계

클래스를 이용해 IP 주소를 지정하는 방법

- 클래스: 네트워크 크기에 따라 IP 주소를 분류하는 기준. 총 A~E까지 다섯개의 클래스가 존재하며 이 중 D,E 는 특수 목적의 예약된 클래스기 때문에 네트워크 크기를 나누는 데는 A,B,C 클래스가 사용됨
  - A 클래스: 비트 '0'으로 시작. 네트워크 주소가 1옥텟으로 구성.
  - B 클래스: 비트 '10'으로 시작. 네트워크 주소가 2옥텟으로 구성.
  - C 클래스: 비트 '110'으로 시작. 네트워크 주소가 3옥텟으로 구성.
- 호스트의 주소 공간 중, 호스트 주소가 전부 0인 네트워크 자체를 의미하는 네트워크 주소로 이용하고 IP 주소와 1인 IP 주소는 브로드캐스트를 위한 주소로 사용함

<br/><br/>

## 클래스리스 주소 체계

클래스풀 주소 체계는 클래스별 네트워크 크기는 여전히 고정되어 있어 다수의 IP 주소가 낭비될 수 있으므로 클래스 개념 없이 클래스에 구애받지 않고 네트워크 영역을 나누어 IP 주소 공간을 할당하는 방법

### 서브넷 마스크

IP 주소상에서 네트워크 주소는 1, 호스트 주소는 0으로 표기한 비트열을 의미함<br/>
(ex. 255.0.0.0 -> 11111111.00000000.00000000.00000000)

- 서브네팅: 서브넷 마스크를 이용해 클래스를 원하는 크기로 더 잘게 쪼개어 사용하는 것. 비트 AND 연산으로 IP 주소와 서브넷 마스크를 비트 AND 연산을 하여 네트워크 주소를 구할 수 있음
- 서브넷 마스크 표기
  - 서브넷 마스크를 10진수로 직접 표기하는 방법
  - CIDR 표기법: IP주소/서브넷 마스크상의 1의 개수 형식으로 표기하는 방법(ex.192.168.0.2/25)

<br/><br/>

## 공인 IP 주소와 사설 IP 주소

### 공인 IP 주소

전 세계에서 고유한 IP 주소로, 인터넷을 이용할 때 사용하는 IP 주소를 의미며 ISP 나 공인 IP 주소 할당 기관을 통해 할당받을 수 잇음

### 사설 IP 주소와 NAT

사설 네트워크에서 사용하기 위한 IP 주소로, 인터넷, 외부네트워크에 공개되지 않은 네트워크를 의미함

- IP 주소 공간 중 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 에 속하는 IP 주소는 사설 IP 주소로 간주함
- 일반적으로 라우터가 사설 IP 주소를 할당함
- NAT(Network Address Translation): 사설 IP 주소와 공인 IP 주소를 변환하는 데 사용. NAT 을 통해 사설 IP 주소를 사용하는 여러 호스트들이 적은 수의 공인 IP 주소를 공유할 수 있음

<br/><br/>

## 정적 IP 주소와 동적 IP 주소

### 정적 할당:

호스트에 직접 IP 주소를 부여하는 방식. 이렇게 할당된 주소가 정적 IP 주소

- 게이드웨이: 서로 다른 네트워크를 연결하는 하드웨어적/소프트웨어적 수단으로 그 중에서 기본 게이트웨이는 호스트가 속한 네트워크 외부로 나가기 위한 기본적인 첫 경로를 의미함

### 동적 할당과 DHCP

직접 호스트가 IP 주소를 입력하지 않아도 호스트에 IP가 동적으로 할당되는 방식. 이렇게 할당된 주소가 동적 IP 주소

- 사용하지 않을 때 회수되고, 할당받을 때마다 다른 주소를 받을 수 있음
- IPv4 주소를 동적으로 할당하는 프로토콜은 DHCPv4 이고 IPv6 주소를 동적으로 할당하는 프로토콜은 DHCPv6
- DHCP를 통한 IP 주소 할당
  - DHCP 서버 간에 메시지를 주고받음으로써 이루어짐
  - 일반적으로는 라우터(공유기)가 서버의 역할을 수행하지만 특정 호스트에 서버 기능을 추가할 수 있음
  - DHCP 서버는 할당 가능한 IP 주소 목록을 관리하다가 클라이언트의 요청시 IP 주소를 할당함
  - DHCP 로 할당받은 IP 주소는 임대기간이 정해져있음
  - 클라이언트 - DHCP 서버 간 메시지 종류
    - DHCP Discover(클라이언트->서버): 클라이언트가 브로드캐스트로 DHCP 서버를 찾음. IP 주소가 할당 전이므로 송신지 IP 주소는 0.0.0.0으로 설정
    - DHCP Offer(서버->클라이언트): IP 주소를 제안함(서브넷 마스크, 임대 기간 등의 정보 포함)
    - DHCP Request(클라이언트->서버): 어떤 IP 주소를 사용하겠다고 알림
    - DHCP ACK(서버->클라이언트): 최종 승인
  - 임대 기간이 끝나면 IP 주소를 재할당 받아야 하지만, 임대 갱신을 통해 임대 기간을 연장할 수 있음. 두 차례 자동으로 임대 갱신이 수행되고 만약 자동 임대 갱신 수행에 실패했다면 IP 주소는 DHCP 서버로 반납됨

<br/><br/>

## 예약 주소

- 루프백 주소: 자기 자신을 가리키는 주소로 로컬 호스트라고도 부름. 127.0.0.1 을 가장 일반적으로 사용. 테스트나 디버깅 용도로 사용
- 0.0.0.0/8: 이 네트워크의 이 호스트. IP 주소를 할당받기 전에 임시로 사용하는 경우가 많음
- 0.0.0.0/0: 모든 임의의 IP 주소. 라우팅에서 주로 활용되고 디폴트 라우트를 나타내기 위해 사용
- 디폴트 라우트: 패킷을 어떤 IP 주소로 전달할지 결정하기 어려울 경우 기본적으로 패킷을 전달할 경로를 의미

<br/><br/><br/><br/>

# 라우팅

## 라우터

- 일반적으로 가정 환경에서는 공유기가 라우터의 역할을 대신함. 공유기는 라우터 기능 뿐 아니라 NAT 기능, DHCP 서버 기능 등 다양한 장치의 기능이 함축되어있는 네트워크 장비임
- L3 스위치라고 부르는 장치도 네트워크 계층의 대표적인 장치지만 오늘날엔 두 장치가 상당 부분 유사해 엄밀하게 구분하진 않음

<br/><br/>

## 라우팅 테이블

특정 수신지까지 도달하기 위한 정보를 명시한 정보

- 호스트 환경에 따라 테이블에 포함된 정보가 달라질 수 있음
- IP 주소, 서브넷 마스크, 다음 홉 은 공통/핵심 정보로 하고 네트워크 인터페이스, 메트릭 등의 정보가 명시되기도 함
  - 수신지 IP 주소와 서브넷 마스크: 최종적으로 패킷을 전달할 대상
  - 다음 홉: 최종 수신지까지 거쳐야 할 호스트의 IP 주소나 인터페이스. 게이트웨이라고 명시되기도 함
  - 네트워크 인터페이스: 패킷을 내보낼 통로. NIC 이름이 직접적으로 명시되거나 인터페이스에 대응하는 IP 주소가 명시되기도 함
  - 메트릭: 해당 경로로 이동하는 데 드는 비용. 패킷을 내보낼 경로를 설정 할때도 낮은 비용의 경로를 선호함
- 라우팅 경로에 없는 경로로 패킷을 전송해야 할 때는 디폴트 라우트로 전송함
- 디폴트 라우트는 모든 IP 주소를 의미하는 0.0.0.0/0 으로 명시

<br/><br/>

## 정적 라우팅과 동적 라우팅

- 정적 라우팅: 사용자가 수동으로 직접 채워 넣은 라우팅 테이블의 항목을 토대로 라우팅되는 방식
- 동적 라우팅: 자동으로 라우팅 테이블 항목을 만드는 방식. 정적 라우팅에서 입력 실수가 발생했거나 경로상 문제가 발생할 경우, 라우팅 테이블이 수시로 변할 수 있기 때문에 우회가 가능함
- 최적의 경로를 찾아 라우팅 테이블에 추가할 때 라우터끼리 서로의 정보를 교환하는데 이 과정에서 사용되는 프로토콜이 (동적) 라우팅 프로토콜임

<br/><br/>

## AS(Autonomous System)

동일한 라우팅 정책으로 운용되는 라우터들의 집단 네트워크

- AS 마다 고유한 AS 번호가 할당되고, 사설 AS 번호도 있지만 일반적으로는 고유한 번호를 일컫는 경우가 많음
- 한 AS 내에는 다수의 라우터가 있고, 라우터들은 AS 내부/외부와 통신이 가능함
- AS 외부와 통신할 경우, AS 경계에서 AS 내외로 통신을 주고받을 수 있는 AS 경계 라우터를 이용함

<br/><br/>

## 라우팅 프로토콜

라우터끼리 자신들의 정보를 교환하며 패킷이 이동할 최적의 경루를 찾기 위한 프로토콜

### IGP(Internal Gateway Protocol)

AS 내부에서 수행되는 프로토콜

- RIP와 OSPF가 있음
- RIP: 거리 벡터를 최적의 경로를 선정하는 과정에서 사용. 인접한 라우터끼리 경로 정보를 주기적으로 교환하며 라우팅 테이블을 갱신하는데, 이를 통해 라우터가 각 수신지에 도달하기까지의 홉 수를 알 수 있음. 홉 수에 따라 메트릭 설정
- OSPF: 링크 상태를 최적의 경로를 선정하는 과정에서 사용. 링크 정보를 비롯한 현재 네트워크 상태를 그래프 형태로 링크 상태 데이터베이스에 저장함. 저장되어 있는 라우터들의 연결 관계, 비용 등 데이터를 기반으로 현재 네트워크 구성을 마치 지도처럼 그린 뒤 최적의 경로를 선택함. 대역폭을 기반으로 메트릭 설정.
- RIP 와 달리 OSPF 는 네트워크의 구성이 변경되었을 때 라우팅 테이블이 갱신 -> 네트워크 규모가 매우 커지면 링크 상태 데이터베이스에는 모든 정보를 저장하기 어렵고, 최적의 경로를 계산하는 부담이 커짐
- EIGRP 라는 고급 거리 벡터 프로토콜과 링크 상태 프로토콜의 성격을 모두 띠는 라우팅 프로토콜도 존재

### EGP: BGP

AS 간의 통신에서 사용되는 대표적인 프로토콜

- 대표적으로 BGP 가 있음
- AS 내 라우터 간 통신도 가능함(내부의 경우 iBGP 라고 하고 외부의 경우 eBGP 라고 함)
- AS 간에 정보를 주고 받기 위해서는 eBGP 를 사용하는 라우터가 하나 있어야 하고 또다른 AS의 BGP 라우터와 연결되어야 함
- 피어: BGP 라우터 간에 BGP 메시지를 주고받음으로써 연결되는데 이때 연결된 BGP 라우터
- 피어링: 피어 관계가 되도록 연결되는 과정
- BGP 는 RIP 와 OSPF 에 비해 최적의 경로 설정 과정이 복잡하고, 일정하지 않은 경우가 많음
- BGP 속성: 겨올에 대한 부가 정보로 AS-PATH, NEXT-HOP, LOCAL-PREF 등이 있음
  - AS-PATH: 메시지가 수신지에 이르는 과정에서 통과하는 AS들의 목록을 의미함. AS를 거칠 때마다 거쳐간 AS가 추가됨
  - NEXT-HOP: 다음으로 거칠 라우터의 IP 주소
  - LOCAL-PREF: AS 내부에서 어떤 경로를 선호할지에 대한 척도를 나타내는 속성. AS-PATH, NEXT-HOP 속성보다 일반적으로는 우선시되고, LOCAL-PREF 속성이 클수록 우선시함. 기본값이 있지만 AS 관리 주체가 설정하는 정책의 영향을 받음.
- BGP 는 AS 간 라우팅을 할 때 거치게 될 라우터의 수가 아닌 AS 의 수를 고려함
- BGP 는 RIP 처럼 단순히 수신지에 이르는 거리가 아닌, 메시지가 어디를 거쳐 어디로 이동하는지 경로를 고려함
- BGP 정책: 특정 AS에서 오는 메시지만 처리하도록 특정 AS를 우대하는 정책을 설정하거나, 특정 AS로부터 오는 메시지를 차단하는 등 라우팅에 있어 경로를 선택하는 중요한 판단 기준 중 하나
